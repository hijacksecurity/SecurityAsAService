name: SCA Security Control

on:
  workflow_call:
    inputs:
      image:
        description: 'Docker image for SCA tool'
        required: false
        type: string
        default: 'semgrep/semgrep:latest'

jobs:
  SCAScan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Run SCA scan
        run: |
          # Create results directory
          mkdir -p results
          
          echo "Running OSS dependency scanning..."
          
          # Check if there are any files to scan
          if ! find . -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.java" -o -name "*.go" -o -name "*.cs" -o -name "package.json" -o -name "requirements.txt" -o -name "go.mod" -o -name "*.csproj" | head -1 | grep -q .; then
            echo "No source code or dependency files found to scan. Creating empty results."
            mkdir -p results
            echo '{"results":[]}' > results/sca-results.json
            echo '{"version":"2.1.0","runs":[{"tool":{"driver":{"name":"semgrep"}},"results":[]}]}' > results/sca-results.sarif
            echo '<?xml version="1.0" encoding="UTF-8"?><testsuite name="SCA"><testcase name="No files to scan" status="skipped"/></testsuite>' > results/sca-results.xml
            echo '<html><body><h1>SCA Report</h1><p>No source code or dependency files found to scan.</p></body></html>' > results/sca-report.html
            exit 0
          fi
          
          # Official semgrep image runs as root, custom images can use non-root
          USER_FLAG=""
          if [[ "${{ inputs.image }}" != *"semgrep/semgrep"* ]]; then
            USER_FLAG="--user $(id -u):$(id -g)"
          fi
          
          # Run dependency scanning with SARIF output
          docker run --rm \
            -v "$GITHUB_WORKSPACE:/src" \
            -w /src \
            $USER_FLAG \
            ${{ inputs.image }} \
            semgrep scan \
              --config=auto \
              --sarif --output=results/sca-results.sarif || echo "SARIF scan completed with exit code $?"
              
          # Run dependency scanning with JSON output
          docker run --rm \
            -v "$GITHUB_WORKSPACE:/src" \
            -w /src \
            $USER_FLAG \
            ${{ inputs.image }} \
            semgrep scan \
              --config=auto \
              --json --output=results/sca-results.json || echo "JSON scan completed with exit code $?"
          
          # Run dependency scanning with JUnit XML output
          docker run --rm \
            -v "$GITHUB_WORKSPACE:/src" \
            -w /src \
            $USER_FLAG \
            ${{ inputs.image }} \
            semgrep scan \
              --config=auto \
              --junit-xml --output=results/sca-results.xml || echo "JUnit XML scan completed with exit code $?"
              
          # Run dependency scanning with HTML output
          docker run --rm \
            -v "$GITHUB_WORKSPACE:/src" \
            -w /src \
            $USER_FLAG \
            ${{ inputs.image }} \
            semgrep scan \
              --config=auto \
              --dataflow-traces \
              --output=results/sca-report.html || echo "HTML report generation completed with exit code $?"
              
          # Fix permissions if running as root (official image)
          if [[ "${{ inputs.image }}" == *"semgrep/semgrep"* ]]; then
            sudo chown -R $(id -u):$(id -g) results/ || true
          fi
        
      - name: Upload to GitHub Security tab
        if: always() && hashFiles('results/sca-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results/sca-results.sarif
          category: sca
          
      - name: Publish JUnit Test Results
        if: always() && hashFiles('results/sca-results.xml') != ''
        uses: dorny/test-reporter@v1
        with:
          name: SCA Security Tests
          path: results/sca-results.xml
          reporter: java-junit
          
      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sca-results
          path: |
            results/sca-results.sarif
            results/sca-results.json
            results/sca-results.xml
            results/sca-report.html
          if-no-files-found: warn